<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>K-COACH | ëŒ€í™”í˜• ì•ˆì „Â·í™˜ê²½ ì½”ì¹˜ (MVP)</title>
  <style>
    body{font-family:system-ui,apple-system,Segoe UI,Roboto,pretendard,sans-serif;margin:0;background:#f7f7fb;color:#111}
    header{padding:24px 20px;background:#111;color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:24px 20px}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:12px;padding:20px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fafafa;cursor:pointer}
    select,input{padding:10px;border:1px solid #ddd;border-radius:8px}
    .muted{color:#666}
    .ok{background:#e6ffe9;border:1px solid #b6f3c3}
    .bad{background:#ffe9e9;border:1px solid #ffb3b3}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 style="margin:0;">K-COACH (ì›¹ MVP)</h1>
    <p style="margin:6px 0 0;">ëŒ€í™”í˜• ì•ˆì „Â·í™˜ê²½ ì½”ì¹˜ â€“ ë¸Œë¼ìš°ì € TTS/STT + ê¸°ë¡</p>
  </div>
</header>

<main class="wrap">
  <!-- 1) íšŒì‚¬/ì‚¬ì—…ì¥/êµ¬ì—­ (ë°ëª¨ìš© Â· ì„ íƒì‚¬í•­) -->
  <div class="card">
    <h2>1) íšŒì‚¬/ì‚¬ì—…ì¥/êµ¬ì—­</h2>
    <div class="row">
      <select id="company">
        <option value="">íšŒì‚¬ ì„ íƒ</option>
        <option>Aì‚¬</option><option>Bì‚¬</option>
      </select>
      <select id="site">
        <option value="">ì‚¬ì—…ì¥ ì„ íƒ</option>
        <option>A-1 ê³µì¥</option><option>B-1 í˜„ì¥</option>
      </select>
      <select id="zone">
        <option value="">êµ¬ì—­ ì„ íƒ</option>
        <option>ë°€íê³µê°„</option><option>ê³ ì˜¨ì‘ì—…ì¥</option>
      </select>
    </div>
    <p class="muted">â€» ì‹œì—°ìš© ë©”íƒ€ë°ì´í„°(ê¸°ë¡ ì €ì¥ ì‹œ í•¨ê»˜ ì €ì¥)</p>
  </div>

  <!-- 2) ì—­í•  -->
  <div class="card">
    <h2>2) ì—­í• </h2>
    <div class="row">
      <label><input type="radio" name="role" value="worker" checked> ê·¼ë¡œì</label>
      <label><input type="radio" name="role" value="supervisor"> ê°ë…ê´€</label>
    </div>
  </div>

  <!-- 3) í•™ìŠµ -->
  <div class="card">
    <h2>3) í•™ìŠµ</h2>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="startBtn">ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" id="askBtn">ì§ˆë¬¸ ë“£ê¸°(TTS)</button>
      <button class="btn" id="speakBtn">ğŸ¤ ëŒ€ë‹µí•˜ê¸°(STT)</button>
      <button class="btn" id="checkBtn">ì±„ì </button>
      <button class="btn" id="nextBtn">ë‹¤ìŒ</button>
    </div>

    <div id="status" class="muted" style="margin-bottom:8px;">questions.jsonì„ ë¶ˆëŸ¬ì™€ ì‹œì‘í•˜ì„¸ìš”.</div>
    <div id="qBox" style="font-weight:700;min-height:40px">â€”</div>
    <div class="card" style="margin-top:12px">
      ì¸ì‹ëœ ë‹µë³€: <span id="ansText" class="muted">ëŒ€ê¸° ì¤‘</span>
    </div>
    <div id="feedback" class="card muted" style="margin-top:8px">í”¼ë“œë°±</div>

    <div class="row" style="margin-top:10px">
      <div class="pill">ì ìˆ˜: <span id="scoreSpan">0</span>/<span id="totalSpan">0</span></div>
    </div>
    <p class="muted" style="margin-top:8px">â€» í¬ë¡¬ ê¶Œì¥(ë¸Œë¼ìš°ì € STT). SafariëŠ” ì œí•œë  ìˆ˜ ìˆì–´ìš”.</p>
  </div>

  <!-- 4) ê´€ë¦¬ì ê¸°ë¡ -->
  <div class="card">
    <h2>4) ê´€ë¦¬ì ê¸°ë¡ (ë¡œì»¬ ì €ì¥)</h2>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="saveBtn">ê²°ê³¼ ì €ì¥</button>
      <button class="btn" id="viewBtn">ê¸°ë¡ ë³´ê¸°</button>
      <button class="btn" id="clearBtn">ê¸°ë¡ ì‚­ì œ</button>
    </div>
    <div id="logBox" class="muted">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>

  <!-- 5) ë„ì… í¬ì¸íŠ¸ -->
  <div class="card">
    <h2>ë„ì… í¬ì¸íŠ¸</h2>
    <ul>
      <li>ë§í•´ì•¼ ë°°ìš°ëŠ” ì–‘ë°©í–¥ í•™ìŠµ â†’ ì‹¤ì œ ëŒ€ì‘ ì ˆì°¨ ì²´í™”</li>
      <li>ë°˜ë³µ í›ˆë ¨ìœ¼ë¡œ ì¤‘ëŒ€ì¬í•´ ì˜ˆë°© ì—­ëŸ‰ ê°•í™”</li>
      <li>ê´€ë¦¬ì: ì·¨ì•½ í•­ëª© í™•ì¸Â·ë³´ì¶©í•™ìŠµ ì„¤ê³„</li>
      <li>ìŠ¤ë§ˆíŠ¸í°/ë¸Œë¼ìš°ì €ë¡œ ì¦‰ì‹œ ë„ì…, ë¹„ìš© ì ˆê°</li>
      <li>ì œì¡°Â·ê±´ì„¤ ë“± ë‹¤ì–‘í•œ í˜„ì¥ ì ìš©</li>
    </ul>
  </div>
</main>

<footer>
  <div class="wrap muted">Â© 2025 K-COACH MVP</div>
</footer>

<script>
  // ===== ìƒíƒœ =====
  let data = null;            // questions.json ì „ì²´
  let scenario = null;        // í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ (ì²« ì‹œë‚˜ë¦¬ì˜¤ ì‚¬ìš©)
  let qi = 0;                 // í˜„ì¬ ë¬¸í•­ index
  let total = 0;              // ì´ ë¬¸í•­ ìˆ˜
  let score = 0;              // ì ìˆ˜
  let heard = "";             // ì¸ì‹ëœ ë‹µë³€
  let answered = false;       // í˜„ì¬ ë¬¸í•­ ì±„ì  ì™„ë£Œ ì—¬ë¶€(ì¤‘ë³µ ê°€ì‚° ë°©ì§€)

  const $ = (id)=>document.getElementById(id);
  const roleEl = ()=>document.querySelector('input[name="role"]:checked')?.value || 'worker';
  const norm = s => (s||'').toLowerCase().replace(/[^ê°€-í£a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();

  // ===== TTS =====
  function speak(text){
    if(!('speechSynthesis' in window)){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    const u = new SpeechSynthesisUtterance(text);
    u.lang='ko-KR'; u.rate=1; u.pitch=1;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }

  // ===== STT =====
  function startSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert('Chromeì—ì„œ ì‹œí—˜í•´ ì£¼ì„¸ìš”(ë¸Œë¼ìš°ì € STT).'); return; }
    const rec = new SR();
    rec.lang='ko-KR'; rec.interimResults=false; rec.maxAlternatives=1;
    heard=''; $('ansText').textContent='ë“£ëŠ” ì¤‘â€¦';
    rec.onresult = e => { heard = e.results[0][0].transcript || ''; $('ansText').textContent = heard; };
    rec.onerror  = ()=> { $('ansText').textContent='ì¸ì‹ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'; };
    rec.start();
  }

  // ===== ë°ì´í„° ë¡œë“œ & ë Œë” =====
  async function loadQuestions(){
    $('status').textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
    const res = await fetch('questions.json');
    data = await res.json();              // {scenarios:[...]}
    scenario = data.scenarios[0];         // ì²« ì‹œë‚˜ë¦¬ì˜¤
    qi = 0; score = 0; answered = false;
    total = scenario.questions.length;
    $('totalSpan').textContent = total;
    $('scoreSpan').textContent = score;
    $('status').textContent='ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
    render();
  }

  function render(){
    if(!scenario) return;
    const q = scenario.questions[qi];
    $('qBox').textContent = `Q${qi+1}. ${q.ask}`;
    $('ansText').textContent = 'ëŒ€ê¸° ì¤‘';
    $('feedback').className = 'card muted';
    $('feedback').textContent = 'í”¼ë“œë°±';
    answered = false;
  }

  // ===== ì±„ì  =====
  function check(){
    if(!scenario) return;
    const q = scenario.questions[qi];
    const t = norm(heard);
    const anyOk = (q.keywords_any||[]).length===0 || (q.keywords_any||[]).some(kw => t.includes(norm(kw)));
    const allOk = (q.keywords_all||[]).every(kw => t.includes(norm(kw)));
    const ok = anyOk && allOk;

    $('feedback').textContent = ok ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤! ì˜í•˜ì…¨ìŠµë‹ˆë‹¤.' : `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. íŒíŠ¸: ${q.hint}`;
    $('feedback').className = ok ? 'card ok' : 'card bad';

    if(ok && !answered){ score++; $('scoreSpan').textContent = score; answered = true; }
  }

  // ===== ë‹¤ìŒ ë¬¸í•­ =====
  function nextQ(){
    if(!scenario) return;
    if(qi+1 < scenario.questions.length){ qi++; render(); }
    else { speak(`êµìœ¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì ìˆ˜ëŠ” ${score}ì , ì´ ${total}ë¬¸í•­ì…ë‹ˆë‹¤.`); }
  }

  // ===== ê´€ë¦¬ì ê¸°ë¡ (localStorage) =====
  function saveResult(){
    if(!scenario) return alert('ë¨¼ì € í•™ìŠµì„ ì§„í–‰í•˜ì„¸ìš”.');
    const key = 'kcoach_results';
    const entry = {
      ts: new Date().toISOString(),
      company: $('company').value || '-',
      site: $('site').value || '-',
      zone: $('zone').value || '-',
      role: roleEl(),
      scenarioId: scenario.id,
      scenarioTitle: scenario.title,
      score, total
    };
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.push(entry);
    localStorage.setItem(key, JSON.stringify(arr));
    alert('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.(ë¡œì»¬)');
  }

  function viewLog(){
    const arr = JSON.parse(localStorage.getItem('kcoach_results') || '[]').reverse();
    if(arr.length===0){ $('logBox').textContent='ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
    const rows = arr.map(r=>`
      <tr>
        <td>${new Date(r.ts).toLocaleString()}</td>
        <td>${r.company}/${r.site}/${r.zone}</td>
        <td>${r.scenarioTitle}</td>
        <td>${r.score} / ${r.total}</td>
        <td>${r.role}</td>
      </tr>`).join('');
    $('logBox').innerHTML = `
      <table>
        <tr>
          <th>ì‹œê°„</th><th>íšŒì‚¬/ì‚¬ì—…ì¥/êµ¬ì—­</th><th>ì‹œë‚˜ë¦¬ì˜¤</th><th>ì ìˆ˜</th><th>ì—­í• </th>
        </tr>${rows}
      </table>`;
  }

  function clearLog(){
    if(confirm('ë¡œì»¬ì— ì €ì¥ëœ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')){
      localStorage.removeItem('kcoach_results');
      $('logBox').textContent='ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
    }
  }

  // ===== ë²„íŠ¼ ì—°ê²° =====
  window.addEventListener('DOMContentLoaded', ()=>{
    $('startBtn').onclick = loadQuestions;
    $('askBtn').onclick   = ()=> scenario && speak(scenario.questions[qi].ask);
    $('speakBtn').onclick = startSTT;
    $('checkBtn').onclick = check;
    $('nextBtn').onclick  = nextQ;

    $('saveBtn').onclick  = saveResult;
    $('viewBtn').onclick  = viewLog;
    $('clearBtn').onclick = clearLog;
  });
</script>
</body>
</html>


